# ~/.bashrc_squeezebox
# ======================================================================
# Bash shell configuration - Squeezebox and Lyrion Music Server controls
# Copyright (c) Corey Goldberg (https://github.com/cgoldberg)
# ======================================================================


LMS_URL="http://10.0.0.100:9000"
SQUEEZEBOX_MAC="00:04:20:23:82:6f"


# send request to LMS JSON-RPC API
send-squeezebox-cmd () {
    local command="$1"
    local payload='{
            "method": "slim.request",
            "params": [
                "'"${SQUEEZEBOX_MAC}"'",
                '"${command}"'
            ]
    }'
    lms_result="$(
        curl \
            --fail \
            --ipv4 \
            --silent \
            --retry 0 \
            --connect-timeout 3 \
            --max-time 10 \
            --data "${payload}" \
            "${LMS_URL}/jsonrpc.js"
    )"
    if [ -z "${lms_result}" ]; then
        err "can't reach LMS or Squeezebox"
        return 1
    fi
}


# show currently playing track on Squeezebox player
squeezebox-show () {
    if send-squeezebox-cmd '["status", "-", 1, "tags:a"]'; then
        jq -r '.result.playlist_loop | .[0] | "\(.artist) - \(.title)"' \
            <<< "${lms_result}" \
            | awk '{print "\033[1m" $0 "\033[0m"}'
    fi
}
alias s=squeezebox-show


# skip to next track in playlist on Squeezebox player
squeezebox-next () {
    if send-squeezebox-cmd '["button", "jump_fwd"]'; then
        squeezebox-show
    fi
}
alias n=squeezebox-next


# play random song mix on Squeezebox player
squeezebox-mix () {
    if send-squeezebox-cmd '["randomplay", "tracks"]'; then
        squeezebox-show
    fi
}
alias m="squeezebox-mix"


# pause/play audio on Squeezebox player
squeezebox-pause () {
    send-squeezebox-cmd '["pause"]'
}
alias p="squeezebox-pause"
