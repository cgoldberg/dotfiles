#!/usr/bin/env python3
#
# Copyright (c) Corey Goldberg (https://github.com/cgoldberg)
#
# generate playlist files from music library for Lyrion Music Server


from collections import defaultdict
from pathlib import Path

DRIVE_PATH = "/mnt/bitz/"
FORMATS = ("FLAC", "MP3")


def generate_playlists(drive_path, formats):
    for fmt in formats:
        music_dir = Path(drive_path) / "Tunes"
        playlist_dir = music_dir / "Playlists" / "Lyrion" / fmt
        playlist_dir.mkdir(exist_ok=True)
        for f in playlist_dir.glob("*.m3u"):
            f.unlink()
        artists_files = defaultdict(list)
        for f in Path(music_dir, fmt).iterdir():
            artist = f.name.split(" - ")[0]
            artists_files[artist].append(f)
        for artist, files in artists_files.items():
            playlist = playlist_dir / f"{artist}.m3u"
            print(f"writing: {playlist}")
            with open(playlist, "w") as f:
                f.write("#EXTM3U\n")
                for file in files:
                    f.write(f"/music/{fmt}/{file.name}\n")


if __name__ == "__main__":
    generate_playlists(DRIVE_PATH, FORMATS)
