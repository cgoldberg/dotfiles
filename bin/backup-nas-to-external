#!/usr/bin/env bash
#
# NAS to external backup script:
#  - mount remote NAS filesystem with CIFS/SMB if needed
#  - sync files from NAS to external USB drive
#
# requires:
#  - rsync

trap 'echo -e "\nAborted"; exit 1' INT


EXPECTED_HOSTS=("minime" "raspberrypi")
NAS_HOST="bitz"
NAS_MNT="/mnt/${NAS_HOST}"
USB_MNT="/media/${USER}/T7Shield"
USB_DIR="${USB_MNT}/backup"
MOUNTS=("${NAS_MNT}" "${USB_MNT}")

SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

check_host () {
    local can_run="false"
    for i in {0..1}; do
        local host="${EXPECTED_HOSTS[${i}]}"
        if [ "${HOSTNAME}" == "${host}" ]; then
            can_run="true"
        fi
    done
    if [ "${can_run}" == "false" ] ; then
        die "fatal: can't run on this host: ${HOSTNAME}"
    fi
}

check_mounts () {
    for mnt in "${MOUNTS[@]}"; do
        if ! findmnt "${mnt}" >/dev/null; then
            die "fatal: ${mnt} not mounted"
        fi
    done
}

check_configuration () {
    if ! type rsync >/dev/null 2>&1; then
        die "fatal: rsync not found"
    fi
}

diskspace () {
    df --human-readable --sync --type=exfat | sed '1{p;s/./-/g;}'
}

eject_usb () {
    local partition=$(findmnt -rno SOURCE "${USB_MNT}")
    local device_name=$(lsblk -rno PKNAME "${partition}")
    local disk="/dev/${device_name}"
    sudo udisksctl unmount -b "${partition}" >/dev/null
    sudo udisksctl power-off -b "${disk}" >/dev/null
}

timer () {
    local start_time=${SECONDS}
    "$@"
    local end_time=${SECONDS}
    local duration=$((end_time - start_time))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))
    printf -v elapsed_time "%02d:%02d:%02d" "${hours}" "${minutes}" "${seconds}"
}

do_backup () {
    echo "syncing ${NAS_MNT} to ${USB_DIR} ..."
    echo
    rsync \
        --delete-during \
        --fsync \
        --human-readable \
        --links \
        --no-whole-file \
        --numeric-ids \
        --progress \
        --recursive \
        --safe-links \
        --stats \
        --times \
        --verbose \
        --verbose \
        --info=progress2 \
        --exclude='d0/' \
        --exclude='d1/' \
        "${NAS_MNT}/" \
        "${USB_DIR}/" \
        | grep -v "file_list pointer array"
}

check_host
check_configuration
echo
mount-bitz
check_mounts
echo
echo "starting backup job ..."
echo
echo "${SEP}"
echo
timer do_backup
echo
echo "${SEP}"
echo
sync "${USB_MNT}"
echo "elapsed time: ${elapsed_time}"
echo
diskspace
echo
eject_usb
ok "ejected external drive"
echo
ok "backup complete"
