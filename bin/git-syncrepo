#!/usr/bin/env bash
#
# Corey Goldberg (https://github.com/cgoldberg)
#
# git-syncrepo - GitHub remote repo sync
#
# - syncs git branches on a remote fork from their parent repo
# - only syncs git branches that have a local counterpart
# - only works if inside a local git repo that was cloned from a fork
# - requires GitHub CLI (https://github.com/cli/cli/blob/trunk/docs/install_linux.md)
#
# usage:
#  - set an environment variable named `GITHUB_USERNAME` with your GitHub account name:
#    - i.e.: `export GITHUB_USERNAME=cgoldberg`
#  - add this script to a directory on your PATH
#  - make this script executable (chmod +x git-syncrepo)
#  - run `git syncrepo` from any directory in a local git repo

set -e

die() { echo "$*" 1>&2 ; exit 1; }

if [ ! -n "${GITHUB_USERNAME}" ]; then
    die "fatal: GITHUB_USERNAME environment variable not set"
fi

if [ ! -x "$(command -v git)" ]; then
    die "fatal: can't find git"
fi

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    die "fatal: not a git repository"
fi

if [ ! -x "$(command -v gh)" ]; then
    die "fatal: can't find GitHub CLI. follow installation instructions at: https://github.com/cli/cli"
fi

repo=$(basename $(basename $(git remote get-url origin)) ".git")
default_branch=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
echo
echo "syncing '${default_branch}' branch on remote fork from its parent"
gh repo sync "${GITHUB_USERNAME}/${repo}" --branch "${default_branch}" || die
echo
branches=($(git branch --format='%(upstream:short)' | grep origin | awk -F '/' '{print $NF}'))
branches_without_default=(${branches[@]/${default_branch}})
for branch in "${branches_without_default[@]}"; do
    echo "syncing '${branch}' branch on remote fork from its parent"
    gh repo sync "${GITHUB_USERNAME}/${repo}" --branch "${branch}"
    echo
done
