#!/usr/bin/env bash
# Corey Goldberg
#
# colorize git status to indicate branch state

set -e

die() { echo "$*" 1>&2 ; exit 1; }

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    die "not in a git repo"
fi

if [[ "${TERM}" != *"256color" ]]; then
    git status
    exit
fi

clean="38;5;82"         # green
untracked="38;5;70"     # faded green
ahead_behind="38;5;226" # yellow
diverged="38;5;196"     # red
staged="38;5;214"       # orange yellow
unstaged="38;5;202"     # orange
dirty="38;5;196"        # red

branch=$(git rev-parse --abbrev-ref HEAD)
status=$(git status)
color="0"

message="Your branch is ahead.+commits."
if [[ "${status}" =~ ${message} ]]; then
    color="${ahead_behind}"
    status=$(sed -E "s/(${message})/\\\033[${color}m\0\\\033[0m/" <<<"${status}")
fi

message="Your branch is behind.+commits."
if [[ "${status}" =~ ${message} ]]; then
    color="${ahead_behind}"
    status=$(sed -E "s/(${message})/\\\033[${color}m\0\\\033[0m/" <<<"${status}")
fi

message="Your branch.+diverged."
if [[ "${status}" =~ ${message} ]]; then
    color="${diverged}"
    status=$(sed -E "s/(${message})/\\\033[${color}m\0\\\033[0m/" <<<"${status}")
fi

messages=(
    "nothing to commit, working tree clean"
    "Untracked files:"
    "Changes to be committed:"
    "Changed but not updated:"
    "Changes not staged for commit:"
    "Unmerged paths:"
)
colors=(
    "${clean}"
    "${untracked}"
    "${staged}"
    "${unstaged}"
    "${unstaged}"
    "${dirty}"
)
for i in ${!messages[@]}; do
    message=${messages[i]}
    if [[ "${status}" =~ "${message}" ]]; then
        color=${colors[i]}
        status=$(sed "s/${message}/\\\033[${color}m${message}\\\033[0m/" <<<"${status}")
    fi
done

# color branch name with last color
colored_status=$(sed "s/${branch}$/\\\033[${color}m${branch}\\\033[0m/" <<<"${status}")
echo -e "${colored_status}"
