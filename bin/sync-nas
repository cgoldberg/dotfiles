#!/usr/bin/env bash
#
# Copyright (c) Corey Goldberg (https://github.com/cgoldberg)
#
# NAS sync script:
#  - mounts remote NAS filesystem with CIFS/SMB if needed
#  - syncs local filesystem
#  - syncs remote filesystem via ssh
#
# requires:
#  - sshpass (file with password must exist at: `~/.ssh/nas_pass.txt`)
#
# note:
#  - run ssh once on host to accept host keys before running this
#    for the first time or it will fail silently


EXPECTED_HOSTS=("minime" "raspberrypi")
PASSWORD_FILE="${HOME}/.ssh/nas_pass.txt"

# 2-bay QNAP
NAS_HOST="bitz"
NAS_IP="10.0.0.5"
NAS_MNT="/mnt/${NAS_HOST}"

SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

check_host () {
    local can_run="false"
    for i in {0..1}; do
        local host="${EXPECTED_HOSTS[${i}]}"
        if [ "${HOSTNAME}" == "${host}" ]; then
            can_run="true"
        fi
    done
    if [ "${can_run}" == "false" ] ; then
        die "fatal: can't run on this host: ${HOSTNAME}"
    fi
}

check_configuration () {
    if ! type sshpass >/dev/null 2>&1; then
        die "sshpass not found"
    fi
    if [ ! -f "${PASSWORD_FILE}" ]; then
        die "password file not found: ${PASSWORD_FILE}"
    fi
}

check_host
check_configuration
echo
mount-bitz
echo
echo "syncing filesystem ..."
sync
sshpass -f "${PASSWORD_FILE}" ssh "admin@${NAS_IP}" "sync"
echo
ok "sync complete"
