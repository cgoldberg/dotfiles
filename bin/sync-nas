#!/usr/bin/env bash
#
# Copyright (c) Corey Goldberg (https://github.com/cgoldberg)
#
# NAS sync script:
#  - mounts remote NAS filesystems with CIFS/SMB if needed
#  - syncs local filesystems
#  - syncs remote filesystems via ssh
#
# requires:
#  - sshpass (file with password must exist)
#
# note:
#  - run ssh once to each host to accept host keys before running this
#    for the first time or it will fail silently


EXPECTED_HOSTS=("minime" "raspberrypi")
PASSWORD_FILE="${HOME}/.ssh/nas_pass.txt"

# 2-bay QNAP
NAS_HOST1="bitz"
NAS_IP1="10.0.0.5"
NAS_MNT1="/mnt/${NAS_HOST1}"

# 1-bay QNAP
NAS_HOST2="bytez"
NAS_IP2="10.0.0.6"
NAS_MNT2="/mnt/${NAS_HOST2}"

NAS_HOSTS=("${NAS_HOST1}" "${NAS_HOST2}")
NAS_IPS=("${NAS_IP1}" "${NAS_IP2}")
NAS_MNTS=("${NAS_MNT1}" "${NAS_MNT2}")

SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

check_host () {
    local can_run="false"
    for i in {0..1}; do
        local host="${EXPECTED_HOSTS[${i}]}"
        if [ "${HOSTNAME}" == "${host}" ]; then
            can_run="true"
        fi
    done
    if [ "${can_run}" == "false" ] ; then
        die "fatal: can't run on this host: ${HOSTNAME}"
    fi
}

check_configuration () {
    if ! type sshpass >/dev/null 2>&1; then
        die "sshpass not found"
    fi
    if [ ! -f "${PASSWORD_FILE}" ]; then
        die "password file not found: ${PASSWORD_FILE}"
    fi
}

sync_all () {
    sync
    for i in {0..1}; do
        sshpass -f "${PASSWORD_FILE}" ssh "admin@${NAS_IPS[${i}]}" "sync"
    done
    sleep 3
}

check_host
check_configuration
echo
mount-bitz
mount-bytez
echo
echo "syncing filesystems ..."
sync_all
echo
ok "sync complete"
