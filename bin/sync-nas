#!/usr/bin/env bash
#
# NAS sync script:
#  - mounts remote NAS filesystems with CIFS/SMB if needed
#  - syncs local filesystems
#  - syncs remote filesystems via ssh
#
# requires:
#  - sshpass (file with password must exist)

set -eou pipefail


PASSWORD_FILE="${HOME}/.ssh/nas_pass.txt"
NAS_USERNAME="cgoldberg"
NAS_SHARE="public"

# 2-bay QNAP
NAS_HOST1="bitz"
NAS_IP1="10.0.0.5"
NAS_MNT1="/mnt/${NAS_HOST1}"

# 1-bay QNAP
NAS_HOST2="bytez"
NAS_IP2="10.0.0.6"
NAS_MNT2="/mnt/${NAS_HOST2}"

NAS_HOSTS=("${NAS_HOST1}" "${NAS_HOST2}")
NAS_IPS=("${NAS_IP1}" "${NAS_IP2}")
NAS_MNTS=("${NAS_MNT1}" "${NAS_MNT2}")

SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

check_configuration () {
    if [ ! -x "$(type -pP sshpass)" ]; then
        die "sshpass not installed"
    fi
    if [ ! -f "${PASSWORD_FILE}" ]; then
        die "password file not found: ${PASSWORD_FILE}"
    fi
}

mount_nas () {
    for i in {0..1}; do
        local nas_host="${NAS_HOSTS[${i}]}"
        local nas_ip="${NAS_IPS[${i}]}"
        local nas_mnt="${NAS_MNTS[${i}]}"
        if ! findmnt "${nas_mnt}" >/dev/null; then
            echo
            echo "mounting //${nas_ip}/${NAS_SHARE} at ${nas_mnt} ..."
            sudo mount -t cifs "//${nas_ip}/${NAS_SHARE}" "${nas_mnt}" \
                -o credentials=/root/.smbcredentials,relatime,nofail,_netdev,gid=1000,uid=1000,file_mode=0664,dir_mode=0775,iocharset=utf8
        fi
    done
}

sync_all () {
    sync
    for i in {0..1}; do
        sshpass -f "${PASSWORD_FILE}" ssh "admin@${NAS_IPS[${i}]}" "sync"
    done
    sleep 3
}

check_configuration
mount_nas
echo
echo "syncing filesystems ..."
sync_all
echo
ok "sync complete"
