#!/usr/bin/env bash
#
# GitHub backup script:
#  - mount remote NAS filesystem with CIFS/SMB if needed
#  - download public GitHub repos/gists (except forks)
#  - archive as zip files
#  - sync files to remote NAS
#
# requires:
#  - rsync
#  - githubtakeout

set -eou pipefail


EXPECTED_HOST="raspberrypi"
NAS_HOST="bitz"
NAS_IP="10.0.0.5"
NAS_SHARE="//${NAS_IP}/public"
BACKUP_LOCAL_PATH="${HOME}/backup"
NAS_MNT="/mnt/${NAS_HOST}"
GITHUB_BACKUP_DIR="GitHub_Backup"
ORIGINAL_DIR="${PWD}"
SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    cd "${ORIGINAL_DIR}"
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

check_host () {
    if [ "${HOSTNAME}" != "${EXPECTED_HOST}" ]; then
        die "fatal: can't run on this host: ${HOSTNAME}" \
            "(required: ${EXPECTED_HOST})"
    fi
}

check_configuration () {
    if [ ! -x "$(type -pP rsync)" ]; then
        die "fatal: rsync not found"
    fi
    if [ ! -x "$(type -pP githubtakeout)" ]; then
        die "fatal: githubtakeout not found"
    fi
    if [ ! -f "./.env" ]; then
        die "fatal: can't find .env file with GITHUB_TOKEN"
    fi
}

delete_old_backups () {
    rm -rf ./backups
    rm -rf "./${GITHUB_BACKUP_DIR}"
}

mount_nas () {
    if ! findmnt "${NAS_MNT}" >/dev/null; then
        echo
        echo "mounting ${NAS_SHARE} at ${NAS_MNT} ..."
        sudo mount -t cifs "${NAS_SHARE}" "${NAS_MNT}" \
            -o credentials=/root/.smbcredentials,relatime,nofail,serverino,nosharesock,_netdev,cache=strict,actimeo=60,rsize=1048576,wsize=1048576,gid=1000,uid=1000,file_mode=0664,dir_mode=0775,iocharset=utf8
    fi
}

timer () {
    local start_time=${SECONDS}
    "$@"
    local end_time=${SECONDS}
    local duration=$((end_time - start_time))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))
    printf -v elapsed_time "%02d:%02d:%02d" "${hours}" "${minutes}" "${seconds}"
}

do_backup () {
    echo "downloading backups of GitHub repos ..."
    echo
    githubtakeout "${GITHUB_USERNAME}" --gists --history --skip_forks
    echo
    echo "${SEP}"
    mv ./backups "./${GITHUB_BACKUP_DIR}"
    sync "${BACKUP_LOCAL_PATH}"
    echo
    echo "syncing "\
        "${BACKUP_LOCAL_PATH}/${GITHUB_BACKUP_DIR} to "\
        "${NAS_MNT}/${GITHUB_BACKUP_DIR} ..."
    echo
    rsync \
        --cvs-exclude \
        --delete-during \
        --fsync \
        --human-readable \
        --links \
        --no-whole-file \
        --progress \
        --recursive \
        --safe-links \
        --stats \
        --times \
        --verbose \
        --info=progress2 \
        "${BACKUP_LOCAL_PATH}/${GITHUB_BACKUP_DIR}/" \
        "${NAS_MNT}/${GITHUB_BACKUP_DIR}/"
    sync "${NAS_MNT}"
}

check_host
echo
echo "changing directory to: ${BACKUP_LOCAL_PATH} ..."
cd "${BACKUP_LOCAL_PATH}"
check_configuration
mount_nas
echo
echo "deleting old local backups ..."
delete_old_backups
echo "starting backup job ..."
echo
echo "${SEP}"
echo
timer do_backup
echo
echo "${SEP}"
echo
echo "changing directory back to: ${ORIGINAL_DIR} ..."
cd "${ORIGINAL_DIR}"
echo
echo "elapsed time: ${elapsed_time}"
echo
ok "backup complete"
