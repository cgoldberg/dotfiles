#!/usr/bin/env bash
#
# data transfer test
# ------------------
# This script tests data transfer speed between 2 remote storage servers
# on my LAN mounted with GVfs and Samba.
#
# - mounts source NAS and destination NAS with GVfs/Samba
# - creates a symlink to each mount point
# - writes a binary test file to the root directory of the source NAS
# - reads test file from source NAS and writes it to root directory of destination NAS
# - deletes test file from source NAS and destination NAS
# - results show transfer speed
#
# requires:
#  - gvfs-backends (apt install)

set -eou pipefail


FILE_NAME="test.img"
FILE_SIZE=100M

NAS_USERNAME="cgoldberg"
NAS_SHARE="public"

# 2-bay QNAP
SOURCE_NAS_HOST="bitz"
SOURCE_NAS_IP="10.0.0.5"
SOURCE_PATH="${HOME}/${SOURCE_NAS_HOST}"

# 1-bay QNAP
DESTINATION_NAS_HOST="bytez"
DESTINATION_NAS_IP="10.0.0.6"
DESTINATION_PATH="${HOME}/${DESTINATION_NAS_HOST}"

SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

check_os () {
    if [[ "${OSTYPE}" != "linux"* ]]; then
        err "fatal: requires Linux"
    fi
}

check_configuration () {
    if [ ! -d "${SOURCE_PATH}" ]; then
        die "fatal: can't find mounted storage: ${SOURCE_PATH}"
    fi

    if [ ! -d "${DESTINATION_PATH}" ]; then
        die "fatal: can't find mounted storage: ${DESTINATION_PATH}"
    fi
}

mount_source_nas () {
    gio mount --unmount "smb://${NAS_USERNAME}@${SOURCE_NAS_IP}/${NAS_SHARE}" 2>/dev/null || true
    gio mount "smb://${NAS_USERNAME}@${SOURCE_NAS_IP}/${NAS_SHARE}"
    ln -s \
        "/run/user/1000/gvfs/smb-share:server=${SOURCE_NAS_IP},share=${NAS_SHARE},user=${NAS_USERNAME}" \
        ~/"${SOURCE_NAS_HOST}" \
        2>/dev/null || true
    until [ -d "${SOURCE_PATH}" ]; do
        sleep .5
    done
}

mount_destination_nas () {
    gio mount --unmount "smb://${NAS_USERNAME}@${DESTINATION_NAS_IP}/${NAS_SHARE}" 2>/dev/null || true
    gio mount "smb://${NAS_USERNAME}@${DESTINATION_NAS_IP}/${NAS_SHARE}"
    ln -s \
        "/run/user/1000/gvfs/smb-share:server=${DESTINATION_NAS_IP},share=${NAS_SHARE},user=${NAS_USERNAME}" \
        ~/"${DESTINATION_NAS_HOST}" \
        2>/dev/null || true
    until [ -d "${DESTINATION_PATH}" ]; do
        sleep .5
    done
}

unmount_source_nas () {
    gio mount --unmount "smb://${NAS_USERNAME}@${SOURCE_NAS_IP}/${NAS_SHARE}"
}

unmount_destination_nas () {
    gio mount --unmount "smb://${NAS_USERNAME}@${DESTINATION_NAS_IP}/${NAS_SHARE}"
}

delete_test_files () {
    rm -f "${SOURCE_PATH}/${FILE_NAME}"
    rm -f "${DESTINATION_PATH}/${FILE_NAME}"
    sync "${SOURCE_PATH}"
    sync "${DESTINATION_PATH}"
}

timer () {
    local start_time=${SECONDS}
    "$@"
    local end_time=${SECONDS}
    local duration=$((end_time - start_time))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))
    printf  -v elapsed_time "%02d:%02d:%02d" "${hours}" "${minutes}" "${seconds}"
}

run_test () {
    # generate the file
    dd \
        if=/dev/zero \
        of="${SOURCE_PATH}/${FILE_NAME}" \
        bs="${FILE_SIZE}" \
        count=1 \
        oflag=dsync \
        conv=fdatasync \
        status=none
    sync "${SOURCE_PATH}"
    # transfer the file
    test_results=$( \
        dd \
            if="${SOURCE_PATH}/${FILE_NAME}" \
            of="${DESTINATION_PATH}/${FILE_NAME}" \
            bs="${FILE_SIZE}" \
            count=1 \
            oflag=dsync,nocache \
            conv=fdatasync \
            2>&1 \
            | grep "copied" \
        )
    sync "${DESTINATION_PATH}"
}

check_os
echo
echo "settings:"
echo "  - test file size: ${FILE_SIZE}"
echo "  - source: ${SOURCE_PATH}"
echo "  - destination: ${DESTINATION_PATH}"
echo
echo "mounting remote storage source ..."
mount_source_nas
echo "mounting remote storage destination ..."
mount_destination_nas
echo "verifying configuration ..."
check_configuration
echo
echo "running data transfer test ..."
echo
timer run_test
echo "${SEP}"
echo
echo "TEST RESULTS:"
echo
tput bold; tput setaf 10; echo "${test_results}"; tput sgr0
echo "elapsed time: ${elapsed_time}"
echo
echo "${SEP}"
echo
delete_test_files
echo "unmounting remote storage source ..."
unmount_source_nas
echo "unmounting remote storage destination ..."
unmount_destination_nas
echo
ok "test complete!"
