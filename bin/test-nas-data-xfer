#!/usr/bin/env bash
#
# data transfer test
# ------------------
# This script tests data transfer speed between 2 remote storage servers
#
# - mounts remote NAS filesystems with CIFS/SMB if needed
# - writes a binary test file to the root directory of the source NAS
# - reads test file from source NAS and writes it to root directory of destination NAS
# - deletes test file from source NAS and destination NAS
# - results show transfer speed and elapsed time

set -eou pipefail


EXPECTED_HOST="raspberrypi"

FILE_NAME="test.img"
FILE_SIZE=100M

NAS_USERNAME="cgoldberg"
NAS_SHARE="public"

# 2-bay QNAP
NAS_HOST1="bitz"
NAS_IP1="10.0.0.5"
NAS_MNT1="/mnt/${NAS_HOST1}"

# 1-bay QNAP
NAS_HOST2="bytez"
NAS_IP2="10.0.0.6"
NAS_MNT2="/mnt/${NAS_HOST2}"

NAS_HOSTS=("${NAS_HOST1}" "${NAS_HOST2}")
NAS_IPS=("${NAS_IP1}" "${NAS_IP2}")
NAS_MNTS=("${NAS_MNT1}" "${NAS_MNT2}")

SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

check_host () {
    if [ "${HOSTNAME}" != "${EXPECTED_HOST}" ]; then
        die "fatal: can't run on this host: ${HOSTNAME}" \
            "(required: ${EXPECTED_HOST})"
    fi
}

mount_nas () {
    for i in {0..1}; do
        local nas_host="${NAS_HOSTS[${i}]}"
        local nas_ip="${NAS_IPS[${i}]}"
        local nas_mnt="${NAS_MNTS[${i}]}"
        if ! findmnt "${nas_mnt}" >/dev/null; then
            echo
            echo "mounting //${nas_ip}/${NAS_SHARE} at ${nas_mnt} ..."
            sudo mount -t cifs "//${nas_ip}/public" "${nas_mnt}" \
                -o credentials=/root/.smbcredentials,relatime,nofail,serverino,nosharesock,_netdev,cache=strict,actimeo=60,rsize=1048576,wsize=1048576,gid=1000,uid=1000,file_mode=0664,dir_mode=0775,iocharset=utf8
        fi
    done
}

delete_test_files () {
    rm -f "${NAS_MNT1}/${FILE_NAME}"
    rm -f "${NAS_MNT2}/${FILE_NAME}"
    sync "${NAS_MNT1}"
    sync "${NAS_MNT2}"
}

timer () {
    local start_time=${SECONDS}
    "$@"
    local end_time=${SECONDS}
    local duration=$((end_time - start_time))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))
    printf  -v elapsed_time "%02d:%02d:%02d" "${hours}" "${minutes}" "${seconds}"
}

run_test () {
    # generate the file
    dd \
        if=/dev/zero \
        of="${NAS_MNT1}/${FILE_NAME}" \
        bs="${FILE_SIZE}" \
        count=1 \
        oflag=dsync \
        conv=fdatasync \
        status=none
    sync "${NAS_MNT1}"
    # transfer the file
    test_results=$( \
        dd \
            if="${NAS_MNT1}/${FILE_NAME}" \
            of="${NAS_MNT2}/${FILE_NAME}" \
            bs="${FILE_SIZE}" \
            count=1 \
            oflag=dsync,nocache \
            conv=fdatasync \
            2>&1 \
            | grep "copied" \
        )
    sync "${NAS_MNT2}"
}

check_host
echo
echo "settings:"
echo
echo "  - file size: ${FILE_SIZE}"
echo "  - source: ${NAS_MNT1}"
echo "  - destination: ${NAS_MNT2}"
mount_nas
echo
echo "running data transfer test ..."
echo
timer run_test
echo "${SEP}"
echo
echo "results:"
echo
tput bold; tput setaf 10; echo "  - ${test_results}"; tput sgr0
echo
echo "elapsed time: ${elapsed_time}"
delete_test_files
echo
echo "${SEP}"
echo
ok "test complete!"
