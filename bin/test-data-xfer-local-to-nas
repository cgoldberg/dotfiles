#!/usr/bin/env bash
#
# Copyright (c) Corey Goldberg (https://github.com/cgoldberg)
#
# data transfer test
# ------------------
# test data transfer speed between local disk and remote storage server
#
# - mounts remote NAS filesystem with CIFS/SMB if needed
# - writes a random binary test file to the /tmp directory of the local disk
# - drops client-side page cache and metadata cache
# - uses random file name to bypass server-side cache
# - reads test file from local disk and writes it to root directory of remote NAS
# - deletes test file from local disk and remote NAS
#
# requires:
# - 'sync-nas' script

trap cleanup SIGINT SIGTERM


EXPECTED_HOSTS=("minime" "raspberrypi")

ITERATIONS="3"
FILE_NAME="$(mktemp -u testfile.XXXXXXXXXX.bin)"
FILE_CHUNK_SIZE="4M"
FILE_CHUNK_COUNT="100"
FILE_SIZE="$(( FILE_CHUNK_COUNT * ${FILE_CHUNK_SIZE%M} ))M"

SOURCE_DIR="/tmp"

# 2-bay QNAP
NAS_HOST="bitz"
NAS_MNT="/mnt/${NAS_HOST}"

SEP="----------------------------------------------------------------"

die () {
    tput bold; tput setaf 1; echo -en "\u2717 " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
    exit 1
}

ok () {
    tput bold; tput setaf 10; echo -en "\u2714  " 1>&2; tput sgr0
    tput bold; echo "$*" 1>&2; tput sgr0
}

cleanup () {
    echo
    delete_test_files
    die "Aborted"
}

check_host () {
    local can_run="false"
    for i in {0..1}; do
        local host="${EXPECTED_HOSTS[${i}]}"
        if [ "${HOSTNAME}" == "${host}" ]; then
            can_run="true"
        fi
    done
    if [ "${can_run}" == "false" ] ; then
        die "fatal: can't run on this host: ${HOSTNAME}"
    fi
}

delete_test_files () {
    rm -f "${SOURCE_DIR}/${FILE_NAME}"
    rm -f "${NAS_MNT2}/${FILE_NAME}"
    sync
    sync "${NAS_MNT}"
}

timer () {
    local start_time=${SECONDS}
    "$@"
    local end_time=${SECONDS}
    local duration=$((end_time - start_time))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))
    printf  -v elapsed_time "%02d:%02d:%02d" "${hours}" "${minutes}" "${seconds}"
}

run_test () {
    # generate the file
    dd \
        if=/dev/urandom \
        of="${SOURCE_DIR}/${FILE_NAME}" \
        bs="${FILE_CHUNK_SIZE}" \
        count="${FILE_CHUNK_COUNT}" \
        conv=fdatasync \
        status=none
    sync
    # drop local cache
    sudo sh -c "echo 3 > /proc/sys/vm/drop_caches"
    # transfer the file
    test_results=$( \
        dd \
            if="${SOURCE_DIR}/${FILE_NAME}" \
            of="${NAS_MNT}/${FILE_NAME}" \
            bs="${FILE_CHUNK_SIZE}" \
            count="${FILE_CHUNK_COUNT}" \
            conv=fdatasync \
            2>&1 \
            | grep "copied" \
        )
    sync "${NAS_MNT}"
}

run () {
    for i in $(seq 1 ${ITERATIONS}); do
        echo "- test #${i} of ${ITERATIONS}:"
        run_test
        delete_test_files
        tput bold; tput setaf 10
        echo "  - ${test_results}"
        if [[ ${test_results} =~ ([0-9]+([.][0-9]+)?)[[:space:]]*MB/s ]]; then
            speed_megabyte_per_sec="${BASH_REMATCH[1]}"
            speed_megabit_per_sec=$(( ${speed_megabyte_per_sec%.*} * 8 ))
            echo "  - ${speed_megabit_per_sec} Mbps"
        fi
        echo
        sleep 0.5
        tput sgr0
    done
}

check_host
sync-nas >/dev/null 2>&1
sleep 1
echo
echo "test settings:"
echo
echo "  - iterations: ${ITERATIONS}"
echo "  - file size: ${FILE_SIZE} (${FILE_CHUNK_SIZE} chunks)"
echo "  - source: ${SOURCE_DIR}"
echo "  - destination: ${NAS_MNT}"
echo
echo "running data transfer tests ..."
echo
echo "${SEP}"
echo
echo "results:"
echo
timer run
echo "${SEP}"
echo
echo "elapsed time: ${elapsed_time}"
echo
ok "tests complete"
