# ~/.bashrc_linux_selenium
# =========================
#  bash shell configuration
# =========================


# only use this file on Linux
if [[ "${OSTYPE}" != "linux"* ]]; then
    return
fi


SELENIUM_HOME="${HOME}/code/selenium"
SELENIUM_MANAGER_HOME="${HOME}/code/selenium_manager_artifacts"


# only activate these functions if we have the selenium repo cloned
if [ ! -d "${SELENIUM_HOME}" ]; then
    return
fi


# kill all running webdrivers and selenium grid server
kill-webdrivers () {
    local processes=(
        "chromedriver"
        "geckodriver"
        "msedgedriver"
        "webkitwebdriver"
        "java"
    )
    for process in "${processes[@]}"; do
        \killall --ignore-case --process-group --quiet --wait "${process}"
    done
    sleep 0.5
    for process in "${processes[@]}"; do
        \killall -9 --ignore-case --process-group --quiet --wait "${process}"
    done
}


# clean selenium dev environment (cache, browsers, webdrivers, build artifacts)
clean-selenium-dev-full () {
    clean-selenium-dev
    local sel_home="${SELENIUM_HOME}"
    local sel_dirs=(
        ${sel_home}/.aspect/
        ${sel_home}/py/selenium/webdriver/common/devtools/
        ${sel_home}/py/selenium/webdriver/common/linux/
        ${sel_home}/py/selenium/webdriver/common/macos/
        ${sel_home}/py/selenium/webdriver/common/windows/
    )
    local symlinks=(
        ${sel_home}/bazel-bin
        ${sel_home}/bazel-genfiles
        ${sel_home}/bazel-out
        ${sel_home}/bazel-selenium
        ${sel_home}/bazel-testlogs
    )
    local dot_dirs=(
        ${HOME}/.cache/bazel/
        ${HOME}/.cache/bazelisk/
        ${HOME}/.cache/google-chrome*/
        ${HOME}/.cache/Microsoft/
        ${HOME}/.cache/mozilla/
        ${HOME}/.cache/pnpm/
        ${HOME}/.cache/selenium/
        ${HOME}/.config/google-chrome*/
        ${HOME}/.config/microsoft-edge*/
        ${HOME}/.mozilla/
    )
    echo "cleaning up selenium cache, browsers, webdrivers, build artifacts ..."
    if [ -d "${sel_home}" ]; then
        for sd in ${sel_dirs[@]}; do
            if [ -d ${sd} ]; then
                echo "deleting ${sd}"
                rm -rf ${sd}
            fi
        done
    fi
    if [ -d "${sel_home}" ]; then
        for sl in ${symlinks[@]}; do
            if [ -L ${sl} ]; then
                echo "deleting ${sl}"
                sudo rm -rf ${sl}
            fi
        done
    fi
    for dd in ${dot_dirs[@]}; do
        if [ -d ${dd} ]; then
            echo "deleting ${dd}"
            sudo rm -rf ${dd}
        fi
    done
}


# clean selenium dev environment
clean-selenium-dev () {
    local sel_home="${SELENIUM_HOME}"
    local dirs=(
        ${sel_home}/.venv/
        ${sel_home}/build/
        ${sel_home}/dist/
        ${sel_home}/venv/
        ${sel_home}/py/.venv/
        ${sel_home}/py/build/
        ${sel_home}/py/dist/
        ${sel_home}/py/venv/
    )
    local recurse_dirs=(
        ${sel_home}/**/.tox/
        ${sel_home}/**/.*_cache/
        ${sel_home}/**/*.egg-info/
        ${sel_home}/**/__pycache__/
    )
    echo "cleaning up selenium dev environment ..."
    if [ -n "${VIRTUAL_ENV}" ]; then
        echo "deactivating venv"
        deactivate
    fi
    for d in ${dirs[@]}; do
        if [ -d ${d} ]; then
            echo "deleting ${d}"
            rm -rf ${d}
        fi
    done
    for rd in ${recurse_dirs[@]}; do
        echo "recursively deleting ${rd}"
        rm -rf ${rd}
    done
}


# run selenium grid server in standalone mode (on port 4444)
# download server first with github cli if it's not found
selenium-server () {
    local sel_home="${SELENIUM_HOME}"
    local server_jar="selenium-server.jar"
    local original_dir="${PWD}"
    if [ ! -x "$(type -pP gh)" ]; then
        err "can't find github cli"
        return 1
    fi
    if [ ! -x "$(type -pP java)" ]; then
        err "can't find java"
        return 1
    fi
    cd "${sel_home}"
    if [ ! -f "${server_jar}" ]; then
        gh release download --pattern="selenium-server*.jar" --output="${server_jar}"
    fi
    java -jar "${server_jar}" standalone
    cd "${original_dir}"
}


# delete and re-install all webdrivers and browsers used by selenium
# also delete and re-download selenium grid server
update-webrivers () {
    kill-webdrivers
    local sel_home="${SELENIUM_HOME}"
    local sel_mgr_home="${SELENIUM_MANAGER_HOME}"
    local sel_mgr_bin="selenium-manager-linux"
    local server_jar="selenium-server.jar"
    local original_dir="${PWD}"
    local dirs=(
        ${HOME}/.cache/google-chrome*/
        ${HOME}/.cache/Microsoft/
        ${HOME}/.cache/mozilla/
        ${HOME}/.cache/selenium/
        ${HOME}/.config/google-chrome*/
        ${HOME}/.config/microsoft-edge*/
        ${HOME}/.mozilla/
    )
    if [ ! -d "${sel_home}" ]; then
        err "${sel_home} not found"
        return 1
    fi
    if [ ! -d "${sel_mgr_home}" ]; then
        err "${sel_mgr_home} not found"
        return 1
    fi
    if [ ! -x "$(type -pP gh)" ]; then
        err "can't find github cli"
        return 1
    fi
    if [ ! -x "$(type -pP java)" ]; then
        err "can't find java"
        return 1
    fi
    if [ "$(arch)" == "aarch64" ]; then
        err "unsupported architecture for selenium manager"
        return 1
    fi
    for d in ${dirs[@]}; do
        if [ -d ${d} ]; then
            echo "deleting ${d}"
            rm -rf ${d}
        fi
    done
    echo
    cd "${sel_mgr_home}"
    echo "updating selenium manager ..."
    gh release download --clobber --pattern="${sel_mgr_bin}" --dir="${sel_home}"
    cd "${sel_home}"
    chmod +x "./${sel_mgr_bin}"
    "./${sel_mgr_bin}" --version
    echo
    echo "updating grid server ..."
    gh release download --clobber --pattern="selenium-server*.jar" --output="${server_jar}"
    java -jar "${server_jar}" info --version
    echo
    echo "updating chrome/chromedriver ..."
    start_spinner
    "./${sel_mgr_bin}" --browser=chrome --driver=chromedriver
    stop_spinner
    echo "updating edge/edgedriver ..."
    start_spinner
    "./${sel_mgr_bin}" --browser=edge --driver=edgedriver
    stop_spinner
    echo "updating firefox/geckodriver ..."
    start_spinner
    "./${sel_mgr_bin}" --browser=firefox --driver=geckodriver
    stop_spinner
    cd "${original_dir}"
}
